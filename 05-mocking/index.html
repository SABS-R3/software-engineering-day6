















<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2021-10-13 12:34:11 +0100">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - Developing better code with automated testing"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <title>
  Mocking for Unit Testing &ndash; Developing better code with automated testing
  </title>  

  </head>
  <body>

    


<div class="panel panel-default life-cycle">
  <div id="life-cycle" class="panel-body beta">
    This lesson is being piloted (Beta version)
  </div>
</div>




    <div class="container">
      






<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/sabs-logo.png" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

        
        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-QandA/index.html">Q&A session</a></li>
            
            <li><a href="../02-introduction/index.html">Introduction</a></li>
            
            <li><a href="../03-automatically-testing-software/index.html">Automatically Testing your Software</a></li>
            
            <li><a href="../04-diagnosing-issues-improving-robustness/index.html">Diagnosing Issues and Improving Robustness</a></li>
            
            <li><a href="../05-mocking/index.html">Mocking for Unit Testing</a></li>
            
            <li><a href="../06-lunch/index.html">Lunch</a></li>
            
            <li><a href="../07-QandA/index.html">Q&A session</a></li>
            
            <li><a href="../08-continuous-integration/index.html">Continuous Integration</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio/index.html">All in one page (Beta)</a></li>
          </ul>
        </li>
	

	
        <li><a href="../LICENSE.html">License</a></li>
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>

















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../04-diagnosing-issues-improving-robustness/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">Developing better code with automated testing</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../06-lunch/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Mocking for Unit Testing</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 25 min
      <br/>
      <strong>Exercises:</strong> 20 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How can we test components in isolation that depend on an external environment or other components?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Describe how to use unittest.mock to replace either a remote call or a dependent function</p>
</li>
	
	<li><p>Use mocking to add to the test suite for our inflammation example</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>Mocking is a testing term that means to replace a real object with a pretend object. One 
of the most common objections to unit testing is that it can be quite difficult to test 
each function or class method in isolation, because of the dependencies that exist in 
all but the simplest code. For example:</p>

<ol>
  <li>Your function/class might depend on a remote resource such as a website, FTP server 
or a cloud-based API that you are calling</li>
  <li>Function A, that you wish to tests, might use another function B as part of its work</li>
  <li>The class you wish to test, class A, might contain an instance of another class B 
that is difficult to construct (i.e. perhaps it depends on loading a large and 
cumbersome dataset).</li>
</ol>

<p>For example 1, you would like your tests to pass even if the computer in question has no 
internet. For example 2, ideally you would want to be able to write a test for function 
A that didn’t depend on function B, so that if a bug occurred in function B, your tests 
for function A would still pass. For example 3, it would be nice to be able to test 
class A without having to construct the difficult-to-create object of class B.</p>

<p>For all these reasons, and many others, you can use mocking libraries to make your unit 
tests easier to write. There are many such libraries/frameworks that exist for different 
languages, for example:</p>

<ul>
  <li><strong>C</strong>: <a href="https://cmocka.org/">CMocka</a></li>
  <li><strong>C++</strong>: <a href="https://github.com/google/googletest">googletest</a></li>
  <li><strong>Python</strong>: <a href="https://docs.python.org/3/library/unittest.mock.html">unittest.mock</a></li>
</ul>

<h1 id="recording-calls-with-mock">Recording calls with mock</h1>

<p>This lesson demonstrates the use of <code class="language-plaintext highlighter-rouge">unittest.mock</code>. This is a mocking framework within 
the Python3 standard library, and is therefore quite convenient to use. The 
documentation for <code class="language-plaintext highlighter-rouge">unittest.mock</code> is 
<a href="https://docs.python.org/3/library/unittest.mock.html">here</a>. This framework contains a 
class <code class="language-plaintext highlighter-rouge">Mock</code>, which is callable and records all the calls that are made to it. For 
example, below we create an object of class <code class="language-plaintext highlighter-rouge">Mock</code>, and tell it to return <code class="language-plaintext highlighter-rouge">2</code> on every 
function call.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span>
<span class="n">function</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"myroutine"</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">function</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2
</code></pre></div></div>

<p>We can call our fake “function” with any number of arguments, with any type. However we 
call the function, it will always return the value <code class="language-plaintext highlighter-rouge">2</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2
</code></pre></div></div>

<p>We can interrogate the <code class="language-plaintext highlighter-rouge">Mock</code> object to allow us to see how it has been called, we can 
use this functionality in tests to assert that the mock object is being called 
correctly. The <code class="language-plaintext highlighter-rouge">mock_calls</code> attribute returns an array of calls made to <code class="language-plaintext highlighter-rouge">function</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span><span class="p">.</span><span class="n">mock_calls</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[call(1), call(5, 'hello', a=True)]
</code></pre></div></div>

<p>Each element of the returned array is a <code class="language-plaintext highlighter-rouge">call</code> object, which stores the arguments for 
each call.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">function</span><span class="p">.</span><span class="n">mock_calls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>((5, 'hello'), {'a': True})
</code></pre></div></div>

<p>Many real-world objects would contain some sort of state, which would change as the 
object is used via side-effects. <code class="language-plaintext highlighter-rouge">Mock</code> objects can also be setup to reproduce this 
behaviour like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"myroutine"</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s">"xyz"</span><span class="p">])</span>
<span class="n">function</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">,</span> <span class="p">{</span><span class="s">'a'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'xyz'
</code></pre></div></div>

<p>Since we have only specified two side-effects for our mock object, we therefore expect 
an error if the function is called again:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">function</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------
StopIteration                             Traceback (most recent call last)
&lt;ipython-input-10-2fcbbbc1fe81&gt; in &lt;module&gt;()
----&gt; 1 function()

C:\ProgramData\Anaconda3\lib\unittest\mock.py in __call__(_mock_self, *args, **kwargs)
    917         # in the signature
    918         _mock_self._mock_check_sig(*args, **kwargs)
--&gt; 919         return _mock_self._mock_call(*args, **kwargs)
    920 
    921 

C:\ProgramData\Anaconda3\lib\unittest\mock.py in _mock_call(_mock_self, *args, **kwargs)
    976 
    977             if not _callable(effect):
--&gt; 978                 result = next(effect)
    979                 if _is_exception(result):
    980                     raise result

StopIteration: 
</code></pre></div></div>

<p>This demonstrates a couple of the features of <code class="language-plaintext highlighter-rouge">unittest.Mock</code> to give you a flavor of 
how it can be used to create a mock object. There are of course many other features of 
the library, for example the ability to create mock methods and attributes for your mock 
object. You can read more about these in the 
<a href="https://docs.python.org/3/library/unittest.mock.html">documentation</a>.</p>

<h1 id="using-mocks-to-model-test-resources">Using mocks to model test resources</h1>

<p>Often we want to write tests for code which interacts with remote resources. (e.g. 
databases, the internet, or data files)</p>

<p>We don’t want to have our tests actually interact with the remote resource, as this 
would mean our tests failed due to lost internet connections, for example.</p>

<p>Instead, we can use mocks to assert that our code does the right thing in terms of the 
messages it sends: the parameters of the function calls it makes to the remote resource.</p>

<p>For example, consider the following code that downloads a map from the internet using 
the Google API:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">map_at</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="n">satellite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
           <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="n">sensor</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">base</span> <span class="o">=</span> <span class="s">"http://maps.googleapis.com/maps/api/staticmap?"</span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">sensor</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sensor</span><span class="p">).</span><span class="n">lower</span><span class="p">(),</span>
        <span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="s">"x"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">size</span><span class="p">)),</span>
        <span class="n">center</span> <span class="o">=</span> <span class="s">","</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,(</span><span class="n">lat</span><span class="p">,</span><span class="nb">long</span><span class="p">))),</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s">"feature:all|element:labels|visibility:off"</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">satellite</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s">"maptype"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"satellite"</span>
        
    <span class="k">return</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

<span class="n">london_map</span> <span class="o">=</span> <span class="n">map_at</span><span class="p">(</span><span class="mf">51.5073509</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1277583</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
</code></pre></div></div>

<p>We would like to write a test to check that the <code class="language-plaintext highlighter-rouge">map_at</code> function is building the 
parameters correctly for the call to the google mapping API. We can do this by mocking 
the requests object. Note that we could simply put a <code class="language-plaintext highlighter-rouge">print</code> statement in the function 
to verify this, but this would have to be removed, so writing a test for this is a more 
long-term and sustainable solution.</p>

<p>We need to temporarily replace a method, specifically the <code class="language-plaintext highlighter-rouge">requests.get()</code> function, with 
a mock. We can use <code class="language-plaintext highlighter-rouge">unittest.mock.patch</code> to do this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="k">with</span> <span class="n">patch</span><span class="p">.</span><span class="nb">object</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span><span class="s">'get'</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
    <span class="n">london_map</span> <span class="o">=</span> <span class="n">map_at</span><span class="p">(</span><span class="mf">51.5073509</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1277583</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">mock_get</span><span class="p">.</span><span class="n">mock_calls</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">patch.object</code> function replaces the named attribute (in this case <code class="language-plaintext highlighter-rouge">get</code>) in the 
named object (<code class="language-plaintext highlighter-rouge">requests</code>), with a mock object <code class="language-plaintext highlighter-rouge">mock_get</code>. In the same manner as we saw 
for the <code class="language-plaintext highlighter-rouge">Mock</code> objects, we can query <code class="language-plaintext highlighter-rouge">mock_get</code> to get the arguments that <code class="language-plaintext highlighter-rouge">requests.get</code> 
was called with.</p>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[call('http://maps.googleapis.com/maps/api/staticmap?', params={'center': '51.5073509,-0.1277583', 'sensor': 'false', 'style': 'feature:all|element:labels|visibility:off', 'size': '400x400', 'zoom': 12})]
</code></pre></div></div>

<p>Our test for the <code class="language-plaintext highlighter-rouge">map_at</code> function then looks like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_build_default_params</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">.</span><span class="nb">object</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span><span class="s">'get'</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
        <span class="n">default_map</span> <span class="o">=</span> <span class="n">map_at</span><span class="p">(</span><span class="mf">51.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">mock_get</span><span class="p">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="s">"http://maps.googleapis.com/maps/api/staticmap?"</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s">'sensor'</span><span class="p">:</span><span class="s">'false'</span><span class="p">,</span>
                <span class="s">'zoom'</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
                <span class="s">'size'</span><span class="p">:</span><span class="s">'400x400'</span><span class="p">,</span>
                <span class="s">'center'</span><span class="p">:</span><span class="s">'51.0,0.0'</span><span class="p">,</span>
                <span class="s">'style'</span><span class="p">:</span><span class="s">'feature:all|element:labels|visibility:off'</span>
            <span class="p">}</span>
        <span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">unittest.patch</code> can be used as a <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch">function 
decorator</a> to 
replace an argument of the function with a mock, it can used to patch a <a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch.object">object 
attribute</a> 
, a 
<a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch.dict">dictionary-like</a> 
object, or to apply 
<a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch.multiple">multiple</a> 
patches as once.</p>

<p>Here is the same test for <code class="language-plaintext highlighter-rouge">map_at</code>, now written using a <code class="language-plaintext highlighter-rouge">patch</code> function decorator.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">patch</span><span class="p">(</span><span class="s">'requests.get'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_build_default_params</span><span class="p">(</span><span class="n">mock_get</span><span class="p">):</span>
      <span class="n">default_map</span> <span class="o">=</span> <span class="n">map_at</span><span class="p">(</span><span class="mf">51.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
      <span class="n">mock_get</span><span class="p">.</span><span class="n">assert_called_with</span><span class="p">(</span>
        <span class="s">"http://maps.googleapis.com/maps/api/staticmap?"</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">{</span>
            <span class="s">'sensor'</span><span class="p">:</span><span class="s">'false'</span><span class="p">,</span>
            <span class="s">'zoom'</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
            <span class="s">'size'</span><span class="p">:</span><span class="s">'400x400'</span><span class="p">,</span>
            <span class="s">'center'</span><span class="p">:</span><span class="s">'51.0,0.0'</span><span class="p">,</span>
            <span class="s">'style'</span><span class="p">:</span><span class="s">'feature:all|element:labels|visibility:off'</span>
        <span class="p">}</span>
      <span class="p">)</span>
</code></pre></div></div>

<h1 id="testing-functions-that-call-other-functions">Testing functions that call other functions</h1>

<p>Often we wish to test a function in isolation from other, dependent functions, so that 
we can write independent tests. For example, we want to test that the below function 
does the right thing. It is supposed to compute the derivative of a function of a vector 
in a particular direction.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">partial_derivative</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="n">x_plus_delta</span> <span class="o">=</span> <span class="n">at</span><span class="p">[:]</span>
    <span class="n">x_plus_delta</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>
    <span class="n">f_x_plus_delta</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x_plus_delta</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">f_x_plus_delta</span> <span class="o">-</span> <span class="n">f_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta</span>
</code></pre></div></div>

<p>We can us the <code class="language-plaintext highlighter-rouge">partial_derivative</code> function to, for example, calculate the derivative of 
the <code class="language-plaintext highlighter-rouge">sum</code> function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">partial_derivative</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.0
</code></pre></div></div>

<p>How do we assert that it is doing the right thing? One way we could do this is to check 
the result of the function against the correct solution. After all, we know that the 
partial derivative of the <code class="language-plaintext highlighter-rouge">sum</code> function should be 1, we could also check the 
performance of the function using other test functions as well. But with mocks we can 
also write a test that is completely independent of the specific function we might use, 
and one that directly tests that the <code class="language-plaintext highlighter-rouge">partial_derivative</code> is doing what you expect it to 
do. Here is a possible test using a <code class="language-plaintext highlighter-rouge">Mock</code> to replace the input <code class="language-plaintext highlighter-rouge">function</code> argument.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span>

<span class="k">def</span> <span class="nf">test_derivative_2d_y_direction</span><span class="p">():</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">partial_derivative</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">func</span><span class="p">.</span><span class="n">assert_any_call</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">func</span><span class="p">.</span><span class="n">assert_any_call</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    

<span class="n">test_derivative_2d_y_direction</span><span class="p">()</span>
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="write-a-unit-test-for-load_csv-using-mocks">Write a unit test for <code class="language-plaintext highlighter-rouge">load_csv</code> using mocks</h2>

  <p>Go back to the <code class="language-plaintext highlighter-rouge">inflammation</code> example that we used in the previous lessons.</p>

  <p>Write a unit test for the <code class="language-plaintext highlighter-rouge">load_csv</code> function in <code class="language-plaintext highlighter-rouge">inflammation/models.py</code>. Use mocking 
to remove the dependence on the <code class="language-plaintext highlighter-rouge">np.loadtxt</code> and <code class="language-plaintext highlighter-rouge">inflammation.models.get_data_dir</code> 
functions. Make sure to test for the two different behaviours of the function which 
occur when the input filename is either absolute or relative.</p>

  <p>Once you are finished, commit your changes and then merge all the new commits on your 
<code class="language-plaintext highlighter-rouge">test-suite</code> branch into `master.</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="o">@</span><span class="n">patch</span><span class="p">(</span><span class="s">'inflammation.models.get_data_dir'</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s">'/data_dir'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_load_csv</span><span class="p">(</span><span class="n">mock_get_data_dir</span><span class="p">):</span>
   <span class="kn">from</span> <span class="nn">inflammation.models</span> <span class="kn">import</span> <span class="n">load_csv</span>
   <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s">'numpy.loadtxt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_loadtxt</span><span class="p">:</span>
       <span class="n">load_csv</span><span class="p">(</span><span class="s">'test.csv'</span><span class="p">)</span>
       <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mock_loadtxt</span><span class="p">.</span><span class="n">mock_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">'fname'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'/data_dir/test.csv'</span>
       <span class="n">load_csv</span><span class="p">(</span><span class="s">'/test.csv'</span><span class="p">)</span>
       <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mock_loadtxt</span><span class="p">.</span><span class="n">mock_calls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
       <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">'fname'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'/test.csv'</span>
<span class="p">...</span>
</code></pre></div>    </div>
  </blockquote>

</blockquote>



<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Mocking is useful for implementing unit tests that test each component in isolation.</p>
</li>
    
    <li><p>Mocking can remove dependencies on external environment such as the internet, the filesystem, or it can remove dependencies from other components</p>
</li>
    
    <li><p>Testing in isolation is essential as it gives you a test suite that can properly identify where bugs are occuring</p>
</li>
    
  </ul>
</blockquote>

</article>
















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../04-diagnosing-issues-improving-robustness/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../06-lunch/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <div class="row">
    <div class="col-md-6 copyright" align="left">
<!--
	
	Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2018–2021
	by <a href="https://carpentries.org/">The Carpentries</a>
        <br>
        Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2016–2018
	by <a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
-->
    </div>
    <div class="col-md-6 help-links" align="right">
	<a href="/blob//CITATION" data-checker-ignore>Cite</a>
	/
	<a href="mailto:s.crouch@software.ac.uk">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
